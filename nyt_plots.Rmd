---
title: "MT County update"
date: "3/28/2020"
output: html_document
---

First load in the data.  Currently have to download the NyTimes county level data by hand and put it in the local directory. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(tidyverse)
library(magrittr)
library(broom)
library(lubridate)
library(reshape2)
library(ggplot2)
library(plotly)
source("./fxns/plot_cases.r")
source("./fxns/est_exp_g.r")

nyt.cases <- read_csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv")
mt.cases <- nyt.cases %>% filter(state == "Montana") %>% 
  mutate(county = as.factor(county))
```

Summary of the NYtimes county level data for Montana looks like: 
```{r mt1}
summary(mt.cases)
```

The current # of cases by county are: 

```{r current}
dat.cur <- mt.cases %>% filter(date == max(date)) %>% select(county, cases, deaths)

ggplot(dat.cur, aes(x = fct_reorder(county, cases, .desc = T), y = cases)) + 
  geom_bar(stat = "identity") + labs(x = "", y = "Current cases") +
  theme_bw() + theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

```

Plot of the cases by county in Montana, but skip the zeros for now.

```{r co-plot}
dat <- mt.cases %>% filter(cases > 0)

plot_cases(mt.cases, cutoff = 1, date.scaled = F, log.scaled = F)
```

Plot it ag but rescaled to a log y axis and starting on the first day since 2 cases.

```{r rescale}
plot_cases(mt.cases, cutoff = 2, date.scaled = T, log.scaled = T)

```

Now estimate the exponential growth rates by county and print the doubling times.

```{r estgrowth}
# estimate growth rates
out <- est_exp_g(mt.cases, cutoff = 3)
r.est <- out$params %>% filter(term == "day") %>% 
  select(county, estimate, std.error)

# calculate the doubling time. (need a double check)  
r.est$t.double <- round(log(2) / log(1 + r.est$estimate), 1)
r.est$lo <- round(log(2) / log(1 + r.est$estimate + 1.96*r.est$std.error),1)
r.est$hi <- round(log(2) / log(1 + r.est$estimate - 1.96*r.est$std.error),1)
table <- r.est  %>% filter(estimate >0) %>% select(county, t.double, lo, hi)
table$hi[table$hi<0] <- NA #assuming a normal error here doesn't work. 
table
```

Show the plot of these estimates. Not sure if I should be forcing the intercept on these. 

```{r plotestgrowth}
p <- ggplot(out$aug.dat, aes(day, cases, color = county)) + 
  geom_point() + 
  geom_line(aes(x = day, y = fit.cases, color = county)) + 
  theme_bw() + theme(legend.position="none")  

ggplotly(p, dynamicTicks = T) 
```

```